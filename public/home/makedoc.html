<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Website</title>
    <link rel="stylesheet" href="style.css"> </head>
<body>
<header>
    <h1>Make a doc</h1>
</header>
<main>
    <section>
        <h2>Docs</h2>
        <input type="checkbox" id="opcion1" name="opcion1" value="minuta">
        <label for="opcion1">minuta</label><br>
        <input type="checkbox" id="opcion2" name="opcion2" value="memorandum">
        <label for="opcion2">memorandum</label><br>
        <input type="checkbox" id="opcion3" name="opcion3" value="memorandum confidencial">
        <label for="opcion3"> memorandum confidencial</label><br>

        <button onclick="makeDoc()">Make doc</button>

        <div id="formid"></div>



    </section>

</main>
<footer>
    <p>&copy; 2023 My Website</p>
</footer>
<!-- home.js -->
<script src="script.js"></script>
<script>
    function makeDoc() {
        var opcion1 = document.getElementById("opcion1").checked;
        var opcion2 = document.getElementById("opcion2").checked;
        var opcion3 = document.getElementById("opcion3").checked;
        let opc = 0;
        var doc = "";
        if (opcion1) {
            doc = "minuta";
            opc = 1;
        } else if (opcion2) {
            doc = "memorandum";
            opc = 2;
        } else if (opcion3) {
            doc = "memorandum confidencial";
            opc = 3;
        }
        console.log("Se ha creado un documento de tipo " + doc);

        mostrarForm(opc);
    }

    var formid = document.getElementById('formid');
    formid.insertAdjacentHTML('beforeend', returnHTMLformid());

    function returnHTMLformid() {
        return `
    <P>selecciona alguna opcion para crer el documento</P>
    `;
    }

    let emailsAdded = [];

    function insertAttendees(correos) {
        console.log('insertAttendees');
        let select = document.getElementById('attendees');
        correos.forEach(correo => {
            let option = document.createElement('option');
            option.value = correo.id_usuario;
            option.text = correo.email;

            select.appendChild(option);
        });
    }


    function addAttendee() {
        console.log('addAttendee');
        const attendees = document.getElementById('attendees');
        if (!attendees) {
            console.log('No se encontró el elemento con id "attendees"');
            return;
        }
        const selectedAttendee = attendees.options[attendees.selectedIndex];
        console.log('selectedAttendee:', selectedAttendee.value);
        if (selectedAttendee.value === '0') {
            console.log('El valor del asistente seleccionado es "0", no se agregará ningún asistente');
            return;
        }

        const selectedAttendeesDiv = document.getElementById('selectedAttendees');
        const newAttendee = document.createElement('div');
        newAttendee.textContent = selectedAttendee.text;
        newAttendee.dataset.id_usuario = selectedAttendee.value;
        const removeButton = document.createElement('button');
        removeButton.textContent = ' Remove';
        removeButton.onclick = () => removeAttendee(removeButton);
        newAttendee.appendChild(removeButton);
        selectedAttendeesDiv.appendChild(newAttendee);
        attendees.remove(attendees.selectedIndex);


    }

    function removeAttendee(button) {
        const attendeeDiv = button.parentNode;
        const id_usuario = attendeeDiv.dataset.id_usuario;

        // Agregar de nuevo al select
        const select = document.getElementById('attendees');
        const option = document.createElement('option');
        option.value = id_usuario;
        option.text = attendeeDiv.textContent.split(' ')[0]; // Obtener el email sin el botón
        option.dataset.id_usuario = id_usuario;
        select.appendChild(option);

        attendeeDiv.remove();
    }

    async function getEmails() {
        try {
            const response = await fetch("/api/emails", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const emails = await response.json();
            return emails;
        } catch (error) {
            console.error("Error al obtener la lista de correos:", error);
            return [];
        }
    }




    async function mostrarForm(opc) {
        console.log('se muestra el form ' + opc);
        let correos = await getEmails();
        // console.log('correos obtenidos mostrarForm:', correitos);

        switch (opc) {
            case 1:
                await formMinuta();
                insertAttendees(correos);
                break;
            case 2:
                await formMemorandum();
                insertAttendees(correos);
                break;
            case 3:
                formMemorandumSecreto();
                break;
            default:
                break;
        }

    }


    async function formMinuta() {
        formid.innerHTML = `
    <form id="minuteForm">
      <label for="meetingTitle">Meeting Title:</label>
      <input type="text" id="meetingTitle" name="meetingTitle" required>

      <label for="attendees">Attendees:</label>
      <div id="selectedAttendees"></div>
      <select id="attendees" name="attendees" required>
        <option value="0">Select an attendee</option>
      </select>
      <button type="button" onclick="addAttendee()">Add Attendee</button>

      <label for="minutesContent">Minutes Content:</label>
      <textarea id="minutesContent" name="minutesContent" rows="10" required></textarea>

      <button type="submit" onclick="enviarMinuta()">Submit</button>
    </form>
  `;

    }
    async function enviarMinuta() {
        console.log('enviarMinuta');
        event.preventDefault();
        const form = document.getElementById('minuteForm');
        const meetingTitle = form.meetingTitle.value;
        const minutesContent = form.minutesContent.value;
        const selectedAttendeesDiv = document.getElementById('selectedAttendees');
        const selectedAttendees = Array.from(selectedAttendeesDiv.children).map(div => div.dataset.id_usuario);

        console.log('meetingTitle:', meetingTitle);
        console.log('minutesContent:', minutesContent);
        console.log('selectedAttendees:', selectedAttendees);

        const data = {
            meetingTitle,
            minutesContent,
            selectedAttendees
        };

        console.log('data de la minuta a enviar:', data);

        try {
            const response = await fetch('/api/CreateMinute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            alert('Resultado de enviarMinuta: ' + result);
            window.location.href = '/home/minutas.html';
        } catch (error) {
            console.error('Error al enviar la minuta:', error);
        }



    }


    async function formMemorandum() {
        formid.innerHTML = `
    <form id="memoForm">
      <label for="memoTitle">Memorandum Title:</label>
      <input type="text" id="memoTitle" name="memoTitle" required>

      <label for="attendees">Destinatarios:</label>
      <div id="selectedAttendees"></div>
      <select id="attendees" name="attendees" required>
        <option value="0">Select an attendee</option>
      </select>
      <button type="button" onclick="addAttendee()">Add Attendee</button>

      <label for="memoContent">Memo Content:</label>
      <textarea id="memoContent" name="memoContent" rows="10" required></textarea>

      <button type="submit" onclick="enviarMemoNormal()">send and sign</button>
    </form>
  `;
    }

    async function enviarMemoNormal() {
        console.log('enviarMemoNormal');
        event.preventDefault();
        const form = document.getElementById('memoForm');
        const memoTitle = form.memoTitle.value;
        const memoContent = form.memoContent.value;

        const selectedAttendeesDiv = document.getElementById('selectedAttendees');
        const selectedAttendees = Array.from(selectedAttendeesDiv.children).map(div => div.dataset.id_usuario);

        const data = {
            memoTitle,
            memoContent,
            selectedAttendees
        };

        console.log('data del memo a enviar:', data);

        try {
            const response = await fetch('/api/CreateMemorandum', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            const resPdfRoute = JSON.stringify(result);
            console.log('Resultado de enviarMemoNormal: ' + resPdfRoute);

            const url = result.url;
            const idDocumento = result.idDocumento;

            console.log('url:', url);
            console.log('idDocumento:', idDocumento);

            // la ruta del pdf es esta: resPdfRoute.url

            // funcion para hacer una peticion al servidor del archivo json, obtener del json el .pdf y luego obtener
            // pasar de base64 a normal,
            await firmalDoc(url, idDocumento);

        } catch (error) {
            console.error('Error al enviar el memorandum:', error);
        }
    }

    async function generateHash(arrayBuffer) {
        // Generar el hash
        const hashBuffer = await window.crypto.subtle.digest('SHA-256', arrayBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer)); // Convertir el hash a un array de bytes

        // Convertir el hash a una cadena hexadecimal
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

        return hashHex;
    }


    async function verifySignature(hash, firma64, publicKey64){

        const hashBuffer = new TextEncoder().encode(hash);

        const signatureArray = Array.from(new Uint8Array(atob(firma64).split('').map(c => c.charCodeAt(0))));
        const signatureBuffer = new Uint8Array(signatureArray).buffer;

        const publicKey = JSON.parse(atob(publicKey64));
        const publicKeyBuffer = await window.crypto.subtle.importKey(
            'jwk', // the format of the key
            publicKey, // the key
            {   // these are the algorithm options
                name: 'RSA-PSS',
                hash: {name: 'SHA-256'}, // or SHA-512
            },
            false, // whether the key is extractable (i.e. can be used in exportKey)
            ['verify'] // can be any combination of "sign" and "verify"
        );

        const signatureVerification = await window.crypto.subtle.verify(
            {
                name: 'RSA-PSS',
                saltLength: 128, // the length of the salt
            },
            publicKeyBuffer, // from generateKey or importKey above
            signatureBuffer, // ArrayBuffer of the signature
            hashBuffer // ArrayBuffer of the data
        );

        //console.log('Verificación de la firma:', signatureVerification);

        return signatureVerification;

    }




    async function firmalDoc(url, idDocumento){
        try{
            console.log('doc.url', url);
            // fetch al url del server
            const pdfResponse = await fetch(url);
            const pdfData = await pdfResponse.json();
            const pdfBlob = new Blob([Uint8Array.from(atob(pdfData.pdf), c => c.charCodeAt(0))], { type: 'application/pdf' });
            const blobUrl = URL.createObjectURL(pdfBlob);

            // hash

            const pdfBuffer = Uint8Array.from(atob(pdfData.pdf), c => c.charCodeAt(0));
            const arrayBuffer = pdfBuffer.buffer.slice(pdfBuffer.byteOffset, pdfBuffer.byteOffset + pdfBuffer.byteLength);
            let hash = await generateHash(arrayBuffer);
            console.log('Hash del pdf: ', hash);


            const fileInput = document.createElement('input');
            fileInput.type = 'file';


            // Escuchar el evento 'change' del input
            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                const reader = new FileReader();

                reader.onload = async (event) => {
                    // El contenido del archivo está en event.target.result
                    const fileContent = event.target.result;
                    let jsonData;
                    try {
                        jsonData = JSON.parse(fileContent);
                    } catch (error) {
                        console.error('Error al parsear el archivo', error);
                    }

                    console.log('jsonData.rsaPrivateKey-->', jsonData.rsaPrivateKey);
                    /*
                    *
                    * */

                    const rsaPrivateKey = jsonData.rsaPrivateKey;
                    const hashBuffer = new TextEncoder().encode(hash);

                    // Import the private key
                    const privateKey = await window.crypto.subtle.importKey(
                        'jwk', // the format of the input key
                        rsaPrivateKey, // this is the JWK format key
                        {   // these are the algorithm options
                            name: 'RSA-PSS',
                            hash: {name: 'SHA-256'}, // or SHA-512
                        },
                        false, // whether the imported key is extractable (i.e. can be used in exportKey)
                        ['sign'] // must contain the "sign" usage
                    );

                    // Now you can use privateKey with window.crypto.subtle.sign
                    const signatureBuffer = await window.crypto.subtle.sign(
                        {
                            name: 'RSA-PSS',
                            saltLength: 128, // the length of the salt
                        },
                        privateKey,
                        hashBuffer
                    );

                    const signatureArray = Array.from(new Uint8Array(signatureBuffer));
                    const signatureHex = signatureArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    console.log('Firma:', signatureHex);

                    const signature64 = btoa(String.fromCharCode.apply(null, signatureArray));
                    console.log('Firma en base64:', signature64);



                    // ahora para motivos de pruebas, verifica la firma
                    const publicKey64 = btoa(JSON.stringify(jsonData.rsaPublicKey));
                    const resVerify = await verifySignature(hash, signature64, publicKey64);
                    console.log('resVerify:', resVerify);


                    // Enviar la firma al servidor
                    const response = await fetch(`/api/docs/sign`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            idDocumento: idDocumento,
                            firma64: signature64
                        })
                    });
                    const data = await response.json();

                    if (data.message === 'ok') {
                        console.log('el servidor recibio la firma y guardó el archivo: ', data);
                    }
                    window.location.href = '/home/minutas.html';
                };

                reader.readAsText(file); // Leer el archivo como texto
            });

            // Simular un click en el input para abrir el selector de archivos
            fileInput.click();

        }
        catch (error){
            console.error('Error al firmar el documento:', error);
        }

    }



    function formMemorandumSecreto(){
        formid.innerHTML = `
    <form id="confidentialMemoForm">
      <label for="confidentialMemoRecipient">Recipient:</label>
      <input type="text" id="confidentialMemoRecipient" name="confidentialMemoRecipient" required>

      <label for="confidentialMemoAuthorizedViewers">Authorized Viewers (comma-separated):</label>
      <input type="text" id="confidentialMemoAuthorizedViewers" name="confidentialMemoAuthorizedViewers" required>

      <label for="confidentialMemoSubject">Subject:</label>
      <input type="text" id="confidentialMemoSubject" name="confidentialMemoSubject" required>

      <label for="confidentialMemoContent">Content:</label>
      <textarea id="confidentialMemoContent" name="confidentialMemoContent" rows="8" required></textarea>

      <button type="submit">Submit</button>
    </form>
    `;

    }


</script>
</body>
</html>
