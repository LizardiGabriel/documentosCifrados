<!DOCTYPE html>
<html>
<head>
    <title>Sign Up</title>
</head>
<body>
<h1>Create an Account</h1>
<form id="signupForm">
    <label for="email">Email:</label>
    <input type="email" id="email" name="email" required><br><br>
    <label for="firstName">First Name:</label>
    <input type="text" id="firstName" name="firstName" required><br><br>
    <label for="lastName">Last Name:</label>
    <input type="text" id="lastName" name="lastName" required><br><br>

    <label for="password">password:</label>
    <input type="text" id="password" name="password" required><br><br>

    <input type="submit" value="Sign Up">


</form>

<script>
    let keyAux, aesKey;
    let  rsaKey, privateKey;
    let n, k, j;

    async function generateAesKey() {
        keyAux = await crypto.subtle.generateKey({name: "AES-GCM", length: 256}, true, ["encrypt", "decrypt"]);
        aesKey = await crypto.subtle.exportKey("jwk", keyAux);
        console.log("Generated AES key:", aesKey.k);
    }

    async function generateRsaKeys() {
        const keys = await crypto.subtle.generateKey({
                name: "RSA-OAEP",
                modulusLength: 2048,
                hash: { name: "SHA-256" },
                publicExponent: new Uint8Array([0x01, 0x00, 0x01]), // 65537
            },
            true, // Extractable
            ["encrypt", "decrypt"] // Usages
        );

        rsaKey = keys;
        privateKey = await crypto.subtle.exportKey("jwk", keys.privateKey);

        //console.log("Generated RSA keys:", { publicKey, privateKey });
        console.log("Generated RSA keys:");
        console.log("n:", privateKey.n);
        console.log("Clave pÃºblica (n, k) k->:", privateKey.e);
        console.log("Clave privada (n, j) j->:", privateKey.d);

        n = privateKey.n;
        k = privateKey.e;
        j = privateKey.d;


    }

    function downloadKeys() {
        const keys = {
            aesKey: aesKey,
            n: n,
            k: k,
            j: j,
        };

        const blob = new Blob([JSON.stringify(keys, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "keys.json";
        a.click();
    }



    document.getElementById("signupForm").addEventListener("submit", async function (event) {
        event.preventDefault();

        var form = document.getElementById("signupForm");
        var formData = new FormData(form);
        var jsonData = {};

        for (var pair of formData.entries()) {
            jsonData[pair[0]] = pair[1];
        }
        await generateAesKey();
        await generateRsaKeys();

        jsonData["RSAn"] = n;
        jsonData["RSAk"] = k;


        console.log("JSON data:", jsonData);


        fetch("/signup", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(jsonData)
        })
            .then(response => response.json())
            .then(data => {
                console.log("Sign up successful:", data);
                if (data.status === 201) {
                    alert("Sign up successful");
                    // usando Web Crypto API generar llaves secreta de forma local
                    // llave aes de 32 bytes
                    // llave publica rsa de 256 bytes
                    // llave privada rsa de 256 bytes
                    // gurardar las llaves en un documento de texto y descargarlo en el navegador

                    downloadKeys();
                } else {
                    alert("Sign up failed");


                }
                // Handle the response from the server
            })
            .catch(error => {
                console.error("Error:", error);
                // Handle any errors that occurred during the request
            });
    });
</script>
</body>
</html>